{
  "schema": "chronicle/v1",
  "commit": "8c2fd355323e93c5319c54ff69d9922cbe3c5f7c",
  "timestamp": "2026-02-06T19:29:42.930474+00:00",
  "task": "MVP+MCP-annotate",
  "summary": "MVP write path implementation with MCP annotate handler. Implements the full ultragit CLI framework, git operations layer, tree-sitter AST parsing, Anthropic LLM provider, writing agent, hooks, pre-LLM filtering, and annotation schema. Adds MCP annotate handler (live path) for zero-cost agent-authored annotations with AST anchor resolution, quality checks, validation, and git notes write.",
  "context_level": "enhanced",
  "regions": [
    {
      "file": "src/mcp/annotate_handler.rs",
      "ast_anchor": {
        "unit_type": "function",
        "name": "handle_annotate",
        "signature": "pub fn handle_annotate(git_ops: &dyn GitOps, input: AnnotateInput) -> Result<AnnotateResult>"
      },
      "lines": {
        "start": 129,
        "end": 189
      },
      "intent": "Core MCP annotate handler — receives structured annotation data from the calling agent, resolves AST anchors to correct line ranges and fill signatures, validates the annotation, and writes it as a git note.",
      "reasoning": "Separated from the batch path (agent loop) because the calling agent already knows intent, reasoning, and constraints. No LLM call needed. The handler reuses existing AST resolution and schema validation.",
      "constraints": [
        {
          "text": "Must always set context_level to Enhanced and ConstraintSource to Author since the authoring agent has direct knowledge.",
          "source": "author"
        },
        {
          "text": "Quality warnings are non-blocking — they're returned to the caller but don't prevent the note from being written.",
          "source": "author"
        },
        {
          "text": "Validation errors (empty summary, invalid line ranges) must reject the annotation entirely — no partial writes.",
          "source": "author"
        }
      ],
      "semantic_dependencies": [
        {
          "file": "src/ast/mod.rs",
          "anchor": "resolve_anchor",
          "nature": "Delegates anchor resolution; assumes it returns None on no match rather than erroring."
        },
        {
          "file": "src/schema/annotation.rs",
          "anchor": "Annotation::validate",
          "nature": "Calls validate() to enforce structural correctness before writing."
        },
        {
          "file": "src/git/mod.rs",
          "anchor": "GitOps::note_write",
          "nature": "Writes the serialized annotation as a git note."
        }
      ],
      "tags": [
        "mcp",
        "live-path",
        "core"
      ]
    },
    {
      "file": "src/mcp/annotate_handler.rs",
      "ast_anchor": {
        "unit_type": "function",
        "name": "resolve_and_build_region",
        "signature": "fn resolve_and_build_region(
    git_ops: &dyn GitOps,
    commit: &str,
    input: &RegionInput,
) -> Result<(RegionAnnotation, AnchorResolution)>"
      },
      "lines": {
        "start": 193,
        "end": 324
      },
      "intent": "Resolve a single region's anchor against the AST outline and build the final RegionAnnotation with corrected lines and filled signature.",
      "reasoning": "Graceful degradation: if the language is unsupported, the file is missing, or the anchor doesn't resolve, the handler falls back to using the input as-is rather than failing the entire annotation.",
      "constraints": [
        {
          "text": "Must never fail the entire annotation due to a single region's anchor not resolving — fallback to input lines and unresolved status.",
          "source": "author"
        }
      ],
      "tags": [
        "ast",
        "anchor-resolution"
      ]
    },
    {
      "file": "src/mcp/annotate_handler.rs",
      "ast_anchor": {
        "unit_type": "function",
        "name": "check_quality",
        "signature": "fn check_quality(input: &AnnotateInput) -> Vec<String>"
      },
      "lines": {
        "start": 89,
        "end": 118
      },
      "intent": "Non-blocking quality feedback — warns the caller about short intent, missing reasoning, or absent constraints without preventing the write.",
      "reasoning": "Quality enforcement should nudge toward better annotations without blocking work. The warnings are returned in the result for the agent to improve next time.",
      "tags": [
        "quality"
      ]
    },
    {
      "file": "src/error.rs",
      "ast_anchor": {
        "unit_type": "enum",
        "name": "UltragitError",
        "signature": "pub enum UltragitError"
      },
      "lines": {
        "start": 6,
        "end": 75
      },
      "intent": "Add Validation variant for annotation structural errors caught by the MCP handler before writing.",
      "reasoning": "Reuses the existing snafu error pattern with module() attribute. Validation is a distinct error category from Git, Provider, or Agent errors.",
      "constraints": [
        {
          "text": "Variant name must not end in 'Error' to avoid collision with the enum name per snafu module() convention.",
          "source": "author"
        }
      ],
      "tags": [
        "error-handling"
      ]
    }
  ],
  "cross_cutting": [
    {
      "description": "Two-path annotation architecture: live path (MCP handler, zero LLM cost, agent provides metadata directly) and batch path (agent loop with API calls, for CI and backfill). Both produce identical Annotation schema output stored as git notes.",
      "regions": [
        {
          "file": "src/mcp/annotate_handler.rs",
          "anchor": "handle_annotate"
        },
        {
          "file": "src/annotate/mod.rs",
          "anchor": "run"
        }
      ],
      "tags": [
        "architecture"
      ]
    }
  ],
  "provenance": {
    "operation": "initial",
    "original_annotations_preserved": false
  }
}
